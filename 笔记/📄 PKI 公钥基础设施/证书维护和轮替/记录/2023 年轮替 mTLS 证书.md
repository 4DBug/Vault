# 2023 年轮替 mTLS 证书

这次维护用了 1Password 帮忙存储和读取 key，不过生成 Private key 的功能尚在 beta 阶段，所以还是先用 openssl 生成。

### 创建今年的文件存储路径

```shell
mkdir -p clients/neko/2023
```

### 生成 Private key 和证书签发请求文件

```shell
openssl genrsa -out clients/neko/2023/client.pem 4096
openssl req -new -key clients/neko/2023/client.pem -out clients/neko/2023/client.csr
```

### 创建证书拓展文件

```shell
cat > clients/neko/2023/client.ext << EOF
basicConstraints = CA:FALSE
nsCertType = client, email
nsComment = "Ayaka Home Users Certificates"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth, emailProtection
EOF
```

### 证书签发

```shell
op read "op://<secret reference>" > intermediates/home_ca_intermediate_1.pem
openssl x509 -req -days 365 -sha256 -extfile clients/neko/2023/client.ext -in clients/neko/2023/client.csr -CA intermediates/home_ca_intermediate_1.crt -CAkey intermediates/home_ca_intermediate_1.pem -out clients/neko/2023/neko.crt -CAcreateserial
rm -rf intermediates/home_ca_intermediate_1.pem
```

### 创建证书链 bundle

``` shell
openssl verify -CAfile intermediates/home_ca_intermediate_1_bundle.crt clients/neko/2023/client.crt
```

### 验证成功后打包为 .p12 格式的文件方便导入导出和安装

```shell
openssl pkcs12 -export -out clients/neko/2023/neko@ayaka.moe.p12 -inkey clients/neko/2023/client.pem -in clients/neko/2023/client.crt
```

成功导入到 KeyStore 里面之后记得删除私钥和证书签发请求文件

```shell
rm -rf clients/neko/2023/client.pem
rm -rf clients/neko/2023/client.csr
```
